name: Codex Auto-Fix on CI Failure

on:
   workflow_run:
      # Trigger this job after any workflow completes with failure
      workflows: ["Lint", "Update Profile with Codex"]
      types: [completed]

permissions:
   contents: write
   pull-requests: write

jobs:
   auto-fix:
      # Only run when the referenced workflow concluded with a failure
      if: ${{ github.event.workflow_run.conclusion == 'failure' }}
      runs-on: ubuntu-latest
      env:
         OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
         FAILED_WORKFLOW_NAME: ${{ github.event.workflow_run.name }}
         FAILED_RUN_URL: ${{ github.event.workflow_run.html_url }}
         FAILED_HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
         FAILED_HEAD_SHA: ${{ github.event.workflow_run.head_sha }}
      steps:
         - name: Check OpenAI API Key Set
           run: |
              if [ -z "$OPENAI_API_KEY" ]; then
                echo "OPENAI_API_KEY secret is not set. Skipping auto-fix." >&2
                exit 1
              fi

         - name: Checkout Failing Ref
           uses: actions/checkout@v4
           with:
              ref: ${{ env.FAILED_HEAD_SHA }}
              fetch-depth: 0

         - name: Setup Node.js (if needed)
           uses: actions/setup-node@v4
           with:
              node-version: "20"
           if: hashFiles('package*.json') != ''

         - name: Install Node dependencies (if needed)
           run: |
              if [ -f package-lock.json ]; then npm ci; elif [ -f package.json ]; then npm install; fi
           if: hashFiles('package*.json') != ''

         - name: Run Codex Auto-Fix
           uses: openai/codex-action@v1
           id: codex
           with:
              openai-api-key: ${{ secrets.OPENAI_API_KEY }}
              prompt: |
                 You are an expert DevOps engineer tasked with fixing a failed GitHub Actions workflow.

                 CONTEXT:
                 - Workflow: ${{ env.FAILED_WORKFLOW_NAME }}
                 - Failed Run: ${{ env.FAILED_RUN_URL }}
                 - Branch: ${{ env.FAILED_HEAD_BRANCH }}
                 - SHA: ${{ env.FAILED_HEAD_SHA }}

                 TASK:
                 1. Analyze the repository structure and workflow files
                 2. Identify the specific cause of the CI failure
                 3. Implement the minimal fix needed to resolve the issue
                 4. Focus on configuration, dependencies, or script issues
                 5. Do NOT refactor unrelated code - keep changes surgical

                 COMMON ISSUES TO CHECK:
                 - Missing dependencies or packages
                 - Incorrect file paths or permissions
                 - Environment variable configuration
                 - Workflow syntax errors
                 - Script execution errors
                 - Authentication or secrets issues

                 Make only the necessary changes to fix the CI failure.
              sandbox: workspace-write
              model: gpt-4o-mini

         - name: Verify Fix (run lint checks)
           run: |
              echo "Running verification checks to ensure fix works..."

              # Check if any scripts exist and can be executed
              if [ -d "scripts" ]; then
                echo "Found scripts directory, checking permissions..."
                find scripts -name "*.sh" -exec chmod +x {} \;
              fi

              # Run the same checks as the Lint workflow
              echo "Running ShellCheck..."
              if find . -name '*.sh' -print0 | xargs -0 shellcheck; then
                echo "‚úÖ ShellCheck passed"
              else
                echo "‚ùå ShellCheck failed"
                exit 1
              fi

              echo "Running MarkdownLint..."
              npm install -g markdownlint-cli
              if markdownlint '**/*.md' --ignore node_modules; then
                echo "‚úÖ MarkdownLint passed"
              else
                echo "‚ùå MarkdownLint failed" 
                exit 1
              fi

              # If there are additional linting scripts, try to run them
              if [ -f "scripts/lint_markdown.sh" ]; then
                echo "Running custom markdown linting..."
                bash scripts/lint_markdown.sh
              fi

              if [ -f "scripts/check_links.sh" ]; then
                echo "Running link checking..."
                bash scripts/check_links.sh || echo "Link checking failed, but continuing..."
              fi

              echo "‚úÖ All verification checks passed!"

         - name: Create pull request with fixes
           if: success()
           uses: peter-evans/create-pull-request@v6
           with:
              commit-message: "fix(ci): auto-fix failing workflow via Codex"
              branch: codex/auto-fix-${{ github.run_id }}
              base: ${{ env.FAILED_HEAD_BRANCH }}
              title: "ü§ñ Auto-fix CI failure via Codex"
              body: |
                 ## Automated CI Fix

                 Codex automatically generated this PR in response to a CI failure.

                 **Failed Workflow:** `${{ env.FAILED_WORKFLOW_NAME }}`  
                 **Failed Run:** ${{ env.FAILED_RUN_URL }}  
                 **Original Branch:** `${{ env.FAILED_HEAD_BRANCH }}`  
                 **Original SHA:** `${{ env.FAILED_HEAD_SHA }}`

                 ### What was fixed
                 This PR contains minimal changes intended solely to make the CI pass. 
                 The fix was automatically identified and implemented by Codex.

                 ### Review Guidelines
                 - ‚úÖ Verify the changes are minimal and targeted
                 - ‚úÖ Check that no unrelated code was modified
                 - ‚úÖ Ensure the fix addresses the root cause
                 - ‚úÖ Test locally if possible before merging

                 *This is an automated fix. Please review carefully before merging.*
              labels: |
                 automated
                 ci-fix
                 codex-generated
