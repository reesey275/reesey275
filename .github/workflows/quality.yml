---
name: Quality Gate

on:
  pull_request:
  push:
  workflow_dispatch:

permissions:
  pull-requests: read
  contents: read

jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Install tools
        shell: bash
        run: |
          set -euo pipefail
          
          # Python tools
          python3 -m pip install --upgrade pip
          python3 -m pip install codespell
          
          # Node tools
          npm install -g markdownlint-cli2
          
          # Vale (pinned version)
          VALE_VERSION="3.11.0"
          curl -fsSL -o vale.tar.gz \
            "https://github.com/errata-ai/vale/releases/download/v${VALE_VERSION}/vale_${VALE_VERSION}_Linux_64-bit.tar.gz"
          tar -xzf vale.tar.gz vale
          sudo mv vale /usr/local/bin/vale
          vale --version

      - name: ShellCheck
        run: |
          find . -name '*.sh' -print0 | xargs -0 shellcheck

      - name: Codespell
        run: |
          codespell \
            --check-filenames \
            --check-hidden \
            --skip="*.lock,*.png,*.jpg,*.jpeg,*.gif,*.svg,*.pdf,node_modules,.git" \
            .

      - name: Markdownlint
        run: |
          markdownlint-cli2 "**/*.md" "#node_modules" "#.git"

      - name: Vale
        run: |
          vale .

      - name: PR Thread Governance
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          bash scripts/pr_threads_guard.sh "${{ github.event.pull_request.number }}" --check
